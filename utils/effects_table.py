import textwrap
import re
from wcwidth import wcswidth

from .logging_utils import (
    BOLD, BLUE, MAGENTA, CYAN, YELLOW, GREEN, RED, RESET
)

# ------------------------------------------------------------
# ANSI-safe helpers
# ------------------------------------------------------------

ANSI_RE = re.compile(r'\x1b\[[0-9;]*m')

def strip_ansi(s: str) -> str:
    return ANSI_RE.sub('', s)

def pad_visible(s: str, width: int) -> str:
    visible = wcswidth(strip_ansi(s))
    if visible < width:
        return s + ' ' * (width - visible)
    return s

# ------------------------------------------------------------
# Effects table
# ------------------------------------------------------------

def show_effects_table():
    effects = [
        (1, "Постеризация", "Чистое упрощение цветов, без фильтров.", "Быстро", "Используй малое число цветов для графичных результатов"),
        (2, "Плавные пятна", "Мягкие переходы, глянец.", "Средне", "Подходит для портретов — увеличь bilateral для более плавного блеска"),
        (3, "Комикс", "Контуры + сглаженные пятна — рисунок тушью.", "Средне", "Уменьши резкость контуров, если слишком агрессивно"),
        (4, "Чернила", "Рисунок тушью: мягкая заливка + жирные линии, эффект наброска.", "Средне", "Попробуй менять силу Canny — линии станут тоньше или выразительнее"),
        (5, "Сетка", "Половинная тонировка/рубрикация — ретро-штриховка.", "Очень быстро", "Шаг сетки влияет на «тон»"),
        (6, "Пыль", "Мягкий шум + рассеянный свет в ярких зонах.", "Быстро", "Для эффекта — увеличь уровень шума и лёгкий blur"),
        (7, "Мел", "Рисование мелом: мягкие, немного сухие границы.", "Быстро", "Поиграй с detail / контрастом для «пыльного» мелка"),
        (8, "ASCII-Арт", "Только символы! Цветной + ЧБ версия.", "Очень быстро", "100% ASCII, без фона. Сохраняет ЧБ отдельно"),
        (9, "Пластик", "Глянцевый, игрушечный, яркие блики.", "Средне", "Добавь specular highlight mask для усиления блеска"),
        (10, "Ретро LCD", "Старый ЖК-экран: крупные пиксели, полосы подсветки, постеризация.", "Быстро", "Понизь масштаб — появятся «квадраты» как на ранних портативных приставках"),
        (11, "Векторизация", "Минималистичный арт из крупных цветных пятен.", "Медленно", "Количество цветов (K) задаёт уровень упрощения — меньше = чище."),
        (12, "Свеча", "Тёплое боковое освещение, золотистые тени.", "Очень быстро", "Подойдёт для сцен с тёплым настроением"),
        (13, "Голограмма", "Радужные переливы, как на CD-диске.", "Средне", "Использует шум, HSV-сдвиг и колормэп для блестящего эффекта"),
        (14, "Акварель", "Мягкие растекающиеся переходы, как кисть и вода.", "Быстро", "Убираем резкие контуры, ставим сильный edge-preserve + blur"),
        (15, "Технический", "Чертёж: белые линии на синем фоне (blueprint).", "Быстро", "Линии — белые, фон — синий; инвертируем каналы правильно"),
        (16, "Карта", "Топографическая палитра — уровни как карта высот.", "Очень быстро", "Подходит для пейзажей/спутника"),
        (17, "Мозаика", "Набор случайных фигур в сетке.", "Медленно", "Чем больше клеток — тем плотнее мозаика"),
        (18, "Сон", "Плывущая, слегка искажённая структура.", "Средне", "Искажения случайны — будут разные каждый раз"),
        (19, "Пиксель-Арт", "Чистая пикселизация (ретро).", "Очень быстро", "scale_factor ~0.05..0.2"),
        (20, "Огненный", "Тёплое свеча/пламя — мягкий glow в тёплых тонах.", "Средне", "Glow делается по яркостной маске, не просто контраст"),
        (21, "Рентген-контур", "Эффект как рентген-снимок: тонкие линии, масштабированные детали, монохром с акцентом цветом.", "Медленно", "Используй инверсию яркости и выделение тонких структур; цветной акцент может подчеркнуть контуры"),
        (22, "Graph", "Графический эффект: контуры + полиномиальная аппроксимация (y = P(x)), монохром с цветными акцентами.", "Медленно", "Используй инверсию яркости, CLAHE и multi-scale детекцию краёв; экспортирует PNG и TXT с уравнениями"),
        (23, "Vice City", "Неоновый ретро-вейв 80-х с VHS-зерном.", "Быстро", "Используй агрессивный Glow и высокий контраст сине-пурпурных оттенков."),
        (24, "TV Box", "Эффект кинескопа: Виньетка, полосы развертки и Рыбий глаз.", "Очень медленно", "Имитирует просмотр через старый ЭЛТ-монитор. Искажение Fish-eye может быть сильным."),
        (25, "Витраж", "Цветные стеклянные ячейки со свинцовыми границами.", "Медленно", "Имитирует классический узор витражного стекла."),
        (26, "Плёнка"   , "Тёплое аналоговое изображение с виньеткой, зерном и мягким свечением.", "Быстро", "Имитирует фотоплёнку: тёплый баланс, затемнение краёв, film grain и лёгкий bloom."),
        (27, "Принтер", "Растровая печать с точками, смещением каналов и текстурой бумаги.", "Медленно", "Имитирует цветную печать: CMY-подобные точки, плохая калибровка и шум бумаги."),
        (28, "Штрих-тень", "Линейная штриховка в зонах естественной тени.", "Медленно", "Определяет реальные тени по локальной яркости и накладывает штриховку, как в манге или карандашном рисунке."),
        (29, "Цвето-фильтер", "текст", "Средне", "фильтр"),
        (30, "Неон", "неон контур", "Средне", "НЕ-ОН"),
        (31, "Дрифт", "Drift", "Средне", "Drift"),
        (32, "Под водой", "Underwater", "Средне", "Underwater"),
    ]

    # widths
    w_num, w_name, w_desc, w_speed = 4, 20, 45, 18
    wrap_desc, wrap_hint = 45, 40

    total_width = w_num + w_name + w_desc + w_speed + wrap_hint

    print(f"\n{CYAN}{'='*total_width}{RESET}")
    print(f"{BOLD}{BLUE}СПИСОК ДОСТУПНЫХ ЭФФЕКТОВ{RESET}")
    print(f"{CYAN}{'-'*total_width}{RESET}")

    header = (
        f"{BOLD}{MAGENTA}{pad_visible('№', w_num)}{RESET}"
        f"{CYAN}{pad_visible('Название', w_name)}{RESET}"
        f"{YELLOW}{pad_visible('Описание', w_desc)}{RESET}"
        f"{GREEN}{pad_visible('Скорость', w_speed)}{RESET}"
        f"{pad_visible('Подсказка', wrap_hint)}"
    )
    print(header)
    print(f"{CYAN}{'-'*total_width}{RESET}")

    for n, name, desc, speed, hint in effects:
        desc_lines = textwrap.wrap(desc, wrap_desc)
        hint_lines = textwrap.wrap(hint, wrap_hint)
        rows = max(len(desc_lines), len(hint_lines))

        for i in range(rows):
            num = pad_visible(str(n), w_num) if i == 0 else " " * w_num
            nm  = pad_visible(name, w_name) if i == 0 else " " * w_name
            sp  = pad_visible(speed, w_speed) if i == 0 else " " * w_speed

            ds = pad_visible(desc_lines[i], w_desc) if i < len(desc_lines) else " " * w_desc
            ht = pad_visible(hint_lines[i], wrap_hint) if i < len(hint_lines) else ""

            print(
                f"{BOLD}{MAGENTA}{num}{RESET}"
                f"{CYAN}{nm}{RESET}"
                f"{YELLOW}{ds}{RESET}"
                f"{GREEN}{sp}{RESET}"
                f"{ht}"
            )

    print(f"{CYAN}{'='*total_width}{RESET}\n")